---
layout: post
title: "状态判断:不同维度的状态混淆问题"
description: "状态判断"
category: 状态机
tags: [software enginering]
---
# 案例 #
最近在做的一个数据迁移的项目，在迁移过程中如果发生错误就有上报错误并回滚之前的迁移操作，为了保持项目独立性就没有用第三方的网络层通信组件。封装了一个跨平台的socket通信组件。 
 
迁移中有一个逻辑：如果迁移时，网络层出现断链错误就认为失败。如果正常迁移完成，就会正常断链（TCP四次握手正常断开）。  

我们的测试环境是suse,AIX,HP。和Linux的通信还算正常，但是AIX和HP之间的通信就不正常了：在正常断链的时候HP端会随机收到RST消息，最后就会报错"Connection rest by peer",于是迁移逻辑就认为是异常断开了（其实是正常退出的）。  

调试了一天，还是没法让HP环境下正常断开。：(  


----------

#解决#
下班之后，回想了一下，发现之前解决的思路错了:  

1. 不同环境，不同机器的断链逻辑很难控制（特别是自己封装的简单的socket），所以这种通信层的状态控制太脆弱了。  

2. 断链只能说明断链了，并不一定说明迁移逻辑失败了，网络层和应用层的状态不应该互相影响。应用层让其网络层该断就断，不该断的时候不要断就行了。  

所以，迁移逻辑是否成功应该由应用层自己来管控，比如：每次迁移完成后，最后都会发一个"end"包，断链之后判断一下是否收到这样的"end"包。所以这就是：不同维度的状态不可以混淆。一旦混用之后，就会导致整个逻辑判断特别脆弱，耦合度也略高。
